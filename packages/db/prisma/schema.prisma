generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector, uuid_ossp(map: "uuid-ossp")]
}

// ============================================
// Enums
// ============================================

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum IntegrationType {
  SHOPIFY
  SHOPLINE
  STRIPE
  CUSTOM
}

enum NftStatus {
  MINTING
  MINTED
  LISTED
  SOLD
  BURNED
}

// ============================================
// Multi-Tenant Core
// ============================================

model Organization {
  id        String   @id @default(cuid())
  clerkId   String   @unique @map("clerk_id")
  name      String
  slug      String   @unique
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members      OrganizationMember[]
  contents     Content[]
  tenantUsage  TenantUsage[]
  products     Product[]
  orders       Order[]
  integrations Integration[]
  wallets      Wallet[]
  nfts         Nft[]

  @@map("organizations")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique @map("clerk_id")
  email     String   @unique
  name      String?
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organizations OrganizationMember[]
  contents      Content[]
  orders        Order[]
  activities    UserActivity[]
  wallets       Wallet[]

  @@map("users")
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  role           Role     @default(MEMBER)
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

// ============================================
// Content
// ============================================

model Content {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  authorId       String        @map("author_id")
  title          String
  slug           String?
  body           String        @db.Text
  status         ContentStatus @default(DRAFT)
  publishedAt    DateTime?     @map("published_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  author       User                  @relation(fields: [authorId], references: [id])
  embeddings   ContentEmbedding[]
  translations ContentTranslation[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([authorId])
  @@index([status])
  @@map("contents")
}

model ContentTranslation {
  id        String   @id @default(cuid())
  contentId String   @map("content_id")
  locale    String   @db.VarChar(10)
  title     String
  body      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, locale])
  @@map("content_translations")
}

// ============================================
// Embeddings (pgvector)
// ============================================

model ContentEmbedding {
  id        String                      @id @default(cuid())
  contentId String                      @map("content_id")
  embedding Unsupported("vector(1536)")
  model     String                      @default("text-embedding-3-small")
  createdAt DateTime                    @default(now()) @map("created_at")

  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@map("content_embeddings")
}

// ============================================
// E-Commerce
// ============================================

model Product {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  externalId     String?  @map("external_id")
  name           String
  description    String?  @db.Text
  price          Decimal  @db.Decimal(10, 2)
  currency       String   @default("USD") @db.VarChar(3)
  inventory      Int      @default(0)
  imageUrl       String?  @map("image_url")
  metadata       Json?    @default("{}")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orderItems   OrderItem[]

  @@unique([organizationId, externalId])
  @@index([organizationId])
  @@map("products")
}

model Order {
  id             String      @id @default(cuid())
  organizationId String      @map("organization_id")
  userId         String      @map("user_id")
  externalId     String?     @map("external_id")
  status         OrderStatus @default(PENDING)
  totalAmount    Decimal     @db.Decimal(10, 2)
  currency       String      @default("USD") @db.VarChar(3)
  shippingInfo   Json?       @map("shipping_info")
  metadata       Json?       @default("{}")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  items        OrderItem[]

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("order_items")
}

model Integration {
  id             String          @id @default(cuid())
  organizationId String          @map("organization_id")
  type           IntegrationType
  name           String
  credentials    Json            @default("{}") // Encrypt in app layer
  settings       Json            @default("{}")
  isActive       Boolean         @default(true) @map("is_active")
  lastSyncAt     DateTime?       @map("last_sync_at")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, type, name])
  @@map("integrations")
}

// ============================================
// Web3
// ============================================

model Wallet {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  address        String   @db.VarChar(42)
  chainId        Int      @map("chain_id")
  isPrimary      Boolean  @default(false) @map("is_primary")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  nfts         Nft[]

  @@unique([address, chainId])
  @@index([userId])
  @@map("wallets")
}

model Nft {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  walletId       String    @map("wallet_id")
  contractAddr   String    @map("contract_addr") @db.VarChar(42)
  tokenId        String    @map("token_id")
  chainId        Int       @map("chain_id")
  name           String?
  description    String?   @db.Text
  imageUrl       String?   @map("image_url")
  metadata       Json?     @default("{}")
  status         NftStatus @default(MINTING)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  wallet       Wallet       @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([contractAddr, tokenId, chainId])
  @@index([walletId])
  @@map("nfts")
}

// ============================================
// User Activity & Analytics
// ============================================

model UserActivity {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  action     String   @db.VarChar(50)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id")
  metadata   Json?    @default("{}")
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("user_activities")
}

// ============================================
// Usage & Billing
// ============================================

model TenantUsage {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  month          String   // Format: YYYY-MM
  apiCalls       Int      @default(0) @map("api_calls")
  aiTokens       Int      @default(0) @map("ai_tokens")
  storage        BigInt   @default(0) // bytes
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, month])
  @@map("tenant_usage")
}

// ============================================
// AI Service Tracking
// ============================================

enum AIProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  SILICONFLOW
  CUSTOM
}

enum AIRequestType {
  GENERATE
  EMBED
  TRANSLATE
  CHAT
}

model AIRequest {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  userId         String?       @map("user_id")
  type           AIRequestType
  provider       AIProvider
  model          String
  inputTokens    Int           @default(0) @map("input_tokens")
  outputTokens   Int           @default(0) @map("output_tokens")
  latencyMs      Int?          @map("latency_ms")
  cost           Decimal?      @db.Decimal(10, 6)
  metadata       Json?         @default("{}")
  createdAt      DateTime      @default(now()) @map("created_at")

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@index([provider, model])
  @@map("ai_requests")
}

// ============================================
// Recommendation System
// ============================================

model UserPreference {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  category       String   @db.VarChar(50)
  weight         Float    @default(1.0)
  metadata       Json?    @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, userId, category])
  @@index([userId])
  @@map("user_preferences")
}

model Recommendation {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  itemType       String   @map("item_type") @db.VarChar(50) // content, product, nft
  itemId         String   @map("item_id")
  score          Float
  reason         String?  @db.VarChar(100) // collaborative, content-based, trending
  shown          Boolean  @default(false)
  clicked        Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  expiresAt      DateTime @map("expires_at")

  @@index([organizationId, userId])
  @@index([itemType, itemId])
  @@index([expiresAt])
  @@map("recommendations")
}

// ============================================
// Feature Flags
// ============================================

enum FeatureFlagType {
  BOOLEAN
  PERCENTAGE
  JSON
}

model FeatureFlag {
  id          String          @id @default(cuid())
  key         String          @unique @db.VarChar(100)
  name        String
  description String?
  type        FeatureFlagType @default(BOOLEAN)
  value       Json            @default("false")
  isEnabled   Boolean         @default(false) @map("is_enabled")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  overrides FeatureFlagOverride[]

  @@map("feature_flags")
}

model FeatureFlagOverride {
  id             String   @id @default(cuid())
  flagId         String   @map("flag_id")
  organizationId String?  @map("organization_id")
  userId         String?  @map("user_id")
  value          Json
  createdAt      DateTime @default(now()) @map("created_at")

  flag FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@unique([flagId, organizationId, userId])
  @@map("feature_flag_overrides")
}

// ============================================
// Billing & Monetization
// ============================================

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  TRIALING
  PAUSED
  INCOMPLETE
}

enum BillingInterval {
  MONTHLY
  YEARLY
  WEEKLY
  ONE_TIME
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum PaymentMethodType {
  CARD
  BANK_TRANSFER
  ALIPAY
  WECHAT_PAY
  CRYPTO
}

enum CreditTransactionType {
  PURCHASE
  USAGE
  REFUND
  ADJUSTMENT
  EXPIRATION
  BONUS
}

enum UsageType {
  API_CALL
  AI_TOKEN
  STORAGE
  COMPUTE
  BANDWIDTH
  CUSTOM
}

// ============================================
// Dynamic Plan Configuration (Unicorn SaaS Pattern)
// ============================================

// Feature Definitions - All possible features in the system
model FeatureDefinition {
  id          String   @id @default(cuid())
  key         String   @unique @db.VarChar(100) // ai.chat, ai.embeddings, web3.nft
  name        String
  description String?
  category    String   @db.VarChar(50) // ai, content, recsys, ecommerce, web3
  valueType   String   @default("boolean") @map("value_type") @db.VarChar(20) // boolean, number, unlimited
  defaultValue Json    @default("false") @map("default_value")
  metadata    Json     @default("{}")
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  planFeatures PlanFeature[]

  @@index([category])
  @@map("feature_definitions")
}

// Usage Limit Definitions - All possible usage metrics
model UsageLimitDefinition {
  id           String   @id @default(cuid())
  key          String   @unique @db.VarChar(50) // ai_tokens, api_calls, storage_bytes
  name         String
  description  String?
  unit         String   @db.VarChar(20) // tokens, calls, bytes, minutes
  resetPeriod  String   @default("monthly") @map("reset_period") @db.VarChar(20) // monthly, daily, never
  overageRate  Decimal? @map("overage_rate") @db.Decimal(10, 8) // cost per unit over limit
  metadata     Json     @default("{}")
  isActive     Boolean  @default(true) @map("is_active")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  planLimits     PlanUsageLimit[]
  customerLimits CustomerUsageLimit[]

  @@map("usage_limit_definitions")
}

// Price/Plan Configuration (Versioned)
model PricingPlan {
  id           String          @id @default(cuid())
  stripeId     String?         @unique @map("stripe_id")
  name         String
  slug         String          @unique @db.VarChar(50) // free, pro, enterprise
  description  String?
  plan         Plan            // FREE, PRO, ENTERPRISE
  interval     BillingInterval @default(MONTHLY)
  amount       Decimal         @db.Decimal(10, 2)
  currency     String          @default("USD") @db.VarChar(3)
  trialDays    Int             @default(0) @map("trial_days")
  
  // Versioning for grandfathering
  version       String         @default("v1") @db.VarChar(20)
  effectiveFrom DateTime       @default(now()) @map("effective_from")
  effectiveTo   DateTime?      @map("effective_to")
  
  // Inheritance
  basePlanId   String?         @map("base_plan_id")
  basePlan     PricingPlan?    @relation("PlanInheritance", fields: [basePlanId], references: [id])
  derivedPlans PricingPlan[]   @relation("PlanInheritance")
  
  // Status
  isActive     Boolean         @default(true) @map("is_active")
  isPublic     Boolean         @default(true) @map("is_public") // show on pricing page
  
  // Legacy JSON fields (for migration, prefer relations)
  features     Json            @default("[]") // Deprecated: use planFeatures
  limits       Json            @default("{}") // Deprecated: use planLimits
  metadata     Json            @default("{}")
  
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  subscriptions    Subscription[]
  invoiceItems     InvoiceItem[]
  planFeatures     PlanFeature[]
  planLimits       PlanUsageLimit[]
  grandfatheredOrgs CustomerPlanVersion[]

  @@unique([slug, version])
  @@index([plan, isActive])
  @@map("pricing_plans")
}

// Plan Features - Many-to-many with values
model PlanFeature {
  id           String   @id @default(cuid())
  planId       String   @map("plan_id")
  featureId    String   @map("feature_id")
  value        Json     // true, false, or specific value
  isEnabled    Boolean  @default(true) @map("is_enabled")
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")

  plan    PricingPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  feature FeatureDefinition @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([planId, featureId])
  @@map("plan_features")
}

// Plan Usage Limits
model PlanUsageLimit {
  id           String   @id @default(cuid())
  planId       String   @map("plan_id")
  limitId      String   @map("limit_id")
  limitValue   BigInt   @map("limit_value") // -1 = unlimited
  overageRate  Decimal? @map("overage_rate") @db.Decimal(10, 8) // override default
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")

  plan       PricingPlan           @relation(fields: [planId], references: [id], onDelete: Cascade)
  limitDef   UsageLimitDefinition  @relation(fields: [limitId], references: [id], onDelete: Cascade)

  @@unique([planId, limitId])
  @@map("plan_usage_limits")
}

// ============================================
// Customer Overrides (Grandfathering & Custom Deals)
// ============================================

// Customer-specific plan version lock (grandfathering)
model CustomerPlanVersion {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  planId         String    @map("plan_id")
  reason         String?   // "Legacy customer", "Enterprise deal", "Beta tester"
  approvedBy     String?   @map("approved_by") // admin user id
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  plan PricingPlan @relation(fields: [planId], references: [id])

  @@unique([organizationId])
  @@map("customer_plan_versions")
}

// Customer-specific feature overrides
model CustomerFeatureOverride {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  featureKey     String    @map("feature_key") @db.VarChar(100)
  value          Json      // override value
  reason         String?   // "Sales deal", "Support escalation"
  approvedBy     String?   @map("approved_by")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@unique([organizationId, featureKey])
  @@index([featureKey])
  @@map("customer_feature_overrides")
}

// Customer-specific usage limit overrides
model CustomerUsageLimit {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  limitId        String    @map("limit_id")
  limitValue     BigInt    @map("limit_value") // -1 = unlimited
  overageRate    Decimal?  @map("overage_rate") @db.Decimal(10, 8)
  reason         String?   // "Enterprise deal", "Promo"
  approvedBy     String?   @map("approved_by")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  limitDef UsageLimitDefinition @relation(fields: [limitId], references: [id])

  @@unique([organizationId, limitId])
  @@map("customer_usage_limits")
}

// Subscription Management
model Subscription {
  id                   String             @id @default(cuid())
  stripeId             String?            @unique @map("stripe_id")
  organizationId       String             @map("organization_id")
  pricingPlanId        String             @map("pricing_plan_id")
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  canceledAt           DateTime?          @map("canceled_at")
  trialStart           DateTime?          @map("trial_start")
  trialEnd             DateTime?          @map("trial_end")
  metadata             Json               @default("{}")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  pricingPlan  PricingPlan @relation(fields: [pricingPlanId], references: [id])
  invoices     Invoice[]
  usageRecords UsageRecord[]

  @@index([organizationId])
  @@index([status])
  @@map("subscriptions")
}

// Invoice Management
model Invoice {
  id               String        @id @default(cuid())
  stripeId         String?       @unique @map("stripe_id")
  organizationId   String        @map("organization_id")
  subscriptionId   String?       @map("subscription_id")
  number           String        @unique
  status           InvoiceStatus @default(DRAFT)
  subtotal         Decimal       @db.Decimal(10, 2)
  tax              Decimal       @default(0) @db.Decimal(10, 2)
  total            Decimal       @db.Decimal(10, 2)
  amountPaid       Decimal       @default(0) @map("amount_paid") @db.Decimal(10, 2)
  amountDue        Decimal       @map("amount_due") @db.Decimal(10, 2)
  currency         String        @default("USD") @db.VarChar(3)
  dueDate          DateTime?     @map("due_date")
  paidAt           DateTime?     @map("paid_at")
  invoicePdf       String?       @map("invoice_pdf")
  hostedInvoiceUrl String?       @map("hosted_invoice_url")
  billingReason    String?       @map("billing_reason") // subscription_create, subscription_cycle, manual
  metadata         Json          @default("{}")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  items        InvoiceItem[]
  payments     Payment[]

  @@index([organizationId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model InvoiceItem {
  id            String   @id @default(cuid())
  invoiceId     String   @map("invoice_id")
  pricingPlanId String?  @map("pricing_plan_id")
  description   String
  quantity      Int      @default(1)
  unitAmount    Decimal  @map("unit_amount") @db.Decimal(10, 4)
  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("USD") @db.VarChar(3)
  periodStart   DateTime @map("period_start")
  periodEnd     DateTime @map("period_end")
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")

  invoice     Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  pricingPlan PricingPlan? @relation(fields: [pricingPlanId], references: [id])

  @@map("invoice_items")
}

// Payment Records
model Payment {
  id                String            @id @default(cuid())
  stripeId          String?           @unique @map("stripe_id")
  organizationId    String            @map("organization_id")
  invoiceId         String?           @map("invoice_id")
  amount            Decimal           @db.Decimal(10, 2)
  currency          String            @default("USD") @db.VarChar(3)
  status            String            @db.VarChar(20) // succeeded, pending, failed
  paymentMethodType PaymentMethodType @map("payment_method_type")
  paymentMethodId   String?           @map("payment_method_id")
  failureCode       String?           @map("failure_code")
  failureMessage    String?           @map("failure_message")
  refundedAmount    Decimal           @default(0) @map("refunded_amount") @db.Decimal(10, 2)
  metadata          Json              @default("{}")
  createdAt         DateTime          @default(now()) @map("created_at")

  invoice       Invoice?       @relation(fields: [invoiceId], references: [id])
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@map("payments")
}

// Payment Methods
model PaymentMethod {
  id             String            @id @default(cuid())
  stripeId       String?           @unique @map("stripe_id")
  organizationId String            @map("organization_id")
  type           PaymentMethodType
  isDefault      Boolean           @default(false) @map("is_default")
  lastFour       String?           @map("last_four") @db.VarChar(4)
  brand          String?           @db.VarChar(20) // visa, mastercard, etc.
  expiryMonth    Int?              @map("expiry_month")
  expiryYear     Int?              @map("expiry_year")
  billingDetails Json?             @map("billing_details") // name, address, email
  metadata       Json              @default("{}")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  payments Payment[]

  @@index([organizationId])
  @@map("payment_methods")
}

// Usage Tracking (detailed)
model UsageRecord {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  subscriptionId String?   @map("subscription_id")
  userId         String?   @map("user_id")
  type           UsageType
  quantity       BigInt
  unitCost       Decimal?  @map("unit_cost") @db.Decimal(10, 8) // cost per unit
  totalCost      Decimal?  @map("total_cost") @db.Decimal(10, 6)
  resource       String?   @db.VarChar(100) // specific resource: gpt-4o, bge-m3, etc.
  metadata       Json      @default("{}")
  recordedAt     DateTime  @default(now()) @map("recorded_at")

  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([organizationId, recordedAt])
  @@index([type])
  @@index([resource])
  @@map("usage_records")
}

// Aggregated Usage (for billing)
model UsageAggregate {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  type           UsageType
  period         String    // YYYY-MM or YYYY-MM-DD
  quantity       BigInt
  cost           Decimal   @db.Decimal(10, 4)
  currency       String    @default("USD") @db.VarChar(3)
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@unique([organizationId, type, period])
  @@map("usage_aggregates")
}

// Credits System
model CreditBalance {
  id             String   @id @default(cuid())
  organizationId String   @unique @map("organization_id")
  balance        Decimal  @default(0) @db.Decimal(10, 4)
  currency       String   @default("USD") @db.VarChar(3)
  updatedAt      DateTime @updatedAt @map("updated_at")

  transactions CreditTransaction[]

  @@map("credit_balances")
}

model CreditTransaction {
  id              String                @id @default(cuid())
  creditBalanceId String                @map("credit_balance_id")
  type            CreditTransactionType
  amount          Decimal               @db.Decimal(10, 4)
  balanceAfter    Decimal               @map("balance_after") @db.Decimal(10, 4)
  description     String?
  expiresAt       DateTime?             @map("expires_at")
  relatedId       String?               @map("related_id") // payment_id, usage_record_id, etc.
  metadata        Json                  @default("{}")
  createdAt       DateTime              @default(now()) @map("created_at")

  creditBalance CreditBalance @relation(fields: [creditBalanceId], references: [id], onDelete: Cascade)

  @@index([creditBalanceId])
  @@index([type])
  @@index([createdAt])
  @@map("credit_transactions")
}

// Feature Entitlements
model Entitlement {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  feature        String    @db.VarChar(100) // ai.chat, ai.embeddings, web3.nft, etc.
  isEnabled      Boolean   @default(true) @map("is_enabled")
  limitValue     BigInt?   @map("limit_value") // null = unlimited
  usedValue      BigInt    @default(0) @map("used_value")
  resetPeriod    String?   @map("reset_period") // monthly, daily, null = never
  lastResetAt    DateTime? @map("last_reset_at")
  expiresAt      DateTime? @map("expires_at")
  source         String    @db.VarChar(20) // plan, addon, trial, custom
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@unique([organizationId, feature])
  @@index([feature])
  @@map("entitlements")
}

// Stripe Customer Mapping
model StripeCustomer {
  id             String   @id @default(cuid())
  organizationId String   @unique @map("organization_id")
  stripeId       String   @unique @map("stripe_id")
  email          String?
  name           String?
  currency       String   @default("USD") @db.VarChar(3)
  taxExempt      String   @default("none") @map("tax_exempt") @db.VarChar(20)
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("stripe_customers")
}

// Webhook Events (for idempotency)
model WebhookEvent {
  id             String    @id @default(cuid())
  provider       String    @db.VarChar(20) // stripe, paypal, etc.
  eventId        String    @map("event_id")
  eventType      String    @map("event_type")
  payload        Json
  processedAt    DateTime? @map("processed_at")
  errorMessage   String?   @map("error_message")
  retryCount     Int       @default(0) @map("retry_count")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@unique([provider, eventId])
  @@index([eventType])
  @@index([processedAt])
  @@map("webhook_events")
}

// ============================================
// Audit Logging
// ============================================

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

model AuditLog {
  id             String      @id @default(cuid())
  organizationId String?     @map("organization_id")
  userId         String?     @map("user_id")
  action         AuditAction
  entityType     String      @map("entity_type") @db.VarChar(50)
  entityId       String?     @map("entity_id")
  oldValue       Json?       @map("old_value")
  newValue       Json?       @map("new_value")
  ipAddress      String?     @map("ip_address") @db.VarChar(45)
  userAgent      String?     @map("user_agent")
  metadata       Json?       @default("{}")
  createdAt      DateTime    @default(now()) @map("created_at")

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
